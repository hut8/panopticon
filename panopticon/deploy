#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICE_NAME="panopticon"
BINARY_PATH="/usr/local/bin/${SERVICE_NAME}"
SERVICE_FILE="${SCRIPT_DIR}/${SERVICE_NAME}.service"
SERVICE_USER="panopticon"

echo "==> Building ${SERVICE_NAME} in release mode..."
cd "${SCRIPT_DIR}"
cargo build --release

echo "==> Ensuring ${SERVICE_USER} system user exists..."
if ! id -u "${SERVICE_USER}" &>/dev/null; then
    sudo useradd --system --no-create-home --shell /usr/sbin/nologin "${SERVICE_USER}"
    echo "    Created system user: ${SERVICE_USER}"
else
    echo "    User ${SERVICE_USER} already exists"
fi

ENV_DIR="/etc/${SERVICE_NAME}"
ENV_FILE="${ENV_DIR}/env"

echo "==> Setting up credentials directory..."
sudo mkdir -p "${ENV_DIR}"
if [ ! -f "${ENV_FILE}" ]; then
    echo "    Creating ${ENV_FILE} with placeholder credentials..."
    sudo tee "${ENV_FILE}" > /dev/null <<'ENVEOF'
UTEC_CLIENT_ID=978782844363a4ccb4d5bcc2cd24d613
UTEC_CLIENT_SECRET=2c44a8f01d13a2b8b01c13b6cf4aa1da
UTEC_SCOPE=openapi
ENVEOF
    echo "    *** Review ${ENV_FILE} and update if needed ***"
else
    echo "    ${ENV_FILE} already exists, not overwriting"
fi
# Only root and the service user should read the credentials
sudo chown root:${SERVICE_USER} "${ENV_FILE}"
sudo chmod 640 "${ENV_FILE}"

echo "==> Stopping ${SERVICE_NAME} service..."
sudo systemctl stop "${SERVICE_NAME}" 2>/dev/null || true

echo "==> Installing binary to ${BINARY_PATH}..."
sudo cp "${SCRIPT_DIR}/target/release/${SERVICE_NAME}" "${BINARY_PATH}"
sudo chmod 755 "${BINARY_PATH}"

CADDY_CONF="/etc/caddy/Caddyfile"
CADDY_INCLUDE="/etc/caddy/Caddyfile.panopticon"
IMPORT_LINE="import /etc/caddy/Caddyfile.panopticon"

echo "==> Installing Caddyfile..."
sudo cp "${SCRIPT_DIR}/Caddyfile" "${CADDY_INCLUDE}"
if ! grep -qF "${IMPORT_LINE}" "${CADDY_CONF}"; then
    echo "${IMPORT_LINE}" | sudo tee -a "${CADDY_CONF}" > /dev/null
    echo "    Added import directive to ${CADDY_CONF}"
else
    echo "    Import directive already present in ${CADDY_CONF}"
fi
sudo systemctl reload caddy

echo "==> Installing systemd service..."
sudo cp "${SERVICE_FILE}" "/etc/systemd/system/${SERVICE_NAME}.service"
sudo systemctl daemon-reload
sudo systemctl enable "${SERVICE_NAME}"

echo "==> Starting ${SERVICE_NAME} service..."
sudo systemctl start "${SERVICE_NAME}"

echo "==> Done. Status:"
sudo systemctl status "${SERVICE_NAME}" --no-pager
