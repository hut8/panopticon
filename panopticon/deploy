#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICE_NAME="panopticon"
BINARY_PATH="/usr/local/bin/${SERVICE_NAME}"
SERVICE_FILE="${SCRIPT_DIR}/${SERVICE_NAME}.service"
SERVICE_USER="panopticon"

echo "==> Building ${SERVICE_NAME} in release mode..."
cd "${SCRIPT_DIR}"
cargo build --release

echo "==> Ensuring ${SERVICE_USER} system user exists..."
if ! id -u "${SERVICE_USER}" &>/dev/null; then
    sudo useradd --system --no-create-home --shell /usr/sbin/nologin "${SERVICE_USER}"
    echo "    Created system user: ${SERVICE_USER}"
else
    echo "    User ${SERVICE_USER} already exists"
fi

echo "==> Stopping ${SERVICE_NAME} service..."
sudo systemctl stop "${SERVICE_NAME}" 2>/dev/null || true

echo "==> Installing binary to ${BINARY_PATH}..."
sudo cp "${SCRIPT_DIR}/target/release/${SERVICE_NAME}" "${BINARY_PATH}"
sudo chmod 755 "${BINARY_PATH}"

echo "==> Installing systemd service..."
sudo cp "${SERVICE_FILE}" "/etc/systemd/system/${SERVICE_NAME}.service"
sudo systemctl daemon-reload
sudo systemctl enable "${SERVICE_NAME}"

echo "==> Starting ${SERVICE_NAME} service..."
sudo systemctl start "${SERVICE_NAME}"

echo "==> Done. Status:"
sudo systemctl status "${SERVICE_NAME}" --no-pager
